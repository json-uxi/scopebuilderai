<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScopeBuilderAI ‚Äî Admin</title>
  <link rel="icon" href="favicon.ico" />

  <style>
    :root { --bg:#0b1220; --card:#121a2a; --muted:#7b8aa5; --text:#e6eeff; --primary:#3a8bff; --accent:#22c55e; --danger:#ef4444; --border:#1f2a44; --input:#0b1322; --shadow:rgba(0,0,0,0.4) }
    html[data-theme="light"] { --bg:#f5f7fb; --card:#fff; --muted:#5a6b87; --text:#0f172a; --primary:#1e3a8a; --accent:#16a34a; --danger:#dc2626; --border:#e5e7eb; --input:#f8fafc; --shadow:rgba(0,0,0,0.06) }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px var(--shadow);padding:24px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
    h1,h3{margin:0 0 12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px}
    .row.center{align-items:center;justify-content:space-between}
    .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#2f66c7 0%,#244e98 100%);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.link{background:transparent;border-color:transparent;color:var(--muted);text-decoration:underline;padding:8px 6px}
    .btn.danger{background:linear-gradient(180deg,#ef4444 0%,#b72d2d 100%)}
    .btn.success{background:linear-gradient(180deg,#23b15a 0%,#1d8f4b 100%)}
    .btn[disabled]{opacity:.6;cursor:progress}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;color:#c9d7ff;background:#1d2a44;border:1px solid var(--border)}
    .divider{height:1px;background:var(--border);margin:16px 0}
    .field{margin:12px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="password"]{width:100%;background:var(--input);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:12px}
    input[type="file"]{color:var(--muted)}
    .logo-box{height:84px;border:1px dashed var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--input);overflow:hidden}
    .logo-box img{max-height:84px;max-width:100%;display:none}
    .alert{display:none;margin-top:10px;padding:10px 12px;border-radius:10px;font-size:14px}
    .alert.ok{background:#0d2b1b;border:1px solid #1b5e33;color:#b1f3c8}
    .alert.err{background:#2b0d0d;border:1px solid #5e1b1b;color:#f3b1b1}
    .theme-toggle{border:1px solid var(--border);background:var(--input);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px}
    .password-wrap{position:relative}
    .toggle-eye-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted);border:1px solid var(--border);background:var(--input);cursor:pointer}
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row center">
        <div>
          <h1>ScopeBuilderAI <span class="pill">Admin</span></h1>
          <div class="muted">White‚Äëlabel settings for your agency</div>
        </div>
        <div class="row" style="gap:10px;">
          <button id="themeToggle" class="theme-toggle" type="button">Dark</button>
          <button id="logoutBtn" class="btn danger" style="display:none;">Log out</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Auth -->
      <section id="authSection">
        <h3>Sign in</h3>
        <form id="loginForm" autocomplete="on">
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="you@agency.com" required />
          </div>
          <div class="field password-wrap">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
            <button id="toggleEye" class="toggle-eye-btn" type="button" aria-label="Show password"><span id="eyeIcon">üëÅÔ∏è</span></button>
          </div>
          <div class="row" style="align-items:center;">
            <button class="btn" type="submit">Sign in</button>
            <button id="forgotBtn" class="btn link" type="button">Forgot password?</button>
          </div>
          <div id="authError" class="alert err"></div>
          <div id="resetInfo" class="alert ok"></div>
        </form>
      </section>

      <!-- Admin dashboard -->
      <section id="adminDashboard" style="display:none;">
        <div class="grid-2">
          <!-- Branding -->
          <div>
            <h3>Branding</h3>
            <div class="field">
              <label>Logo</label>
              <div class="logo-box">
                <img id="logoImg" alt="Logo preview" />
                <span id="logoPlaceholder" class="muted">No logo uploaded</span>
              </div>
              <input id="logoFile" type="file" accept="image/*" />
            </div>
            <div class="field">
              <label for="siteTitle">Site title</label>
              <input id="siteTitle" type="text" placeholder="ScopeBuilderAI" />
            </div>
            <div class="field">
              <label for="tagline">Tagline</label>
              <input id="tagline" type="text" placeholder="Professional Proposal Generator" />
            </div>
            <button id="saveBrandingBtn" class="btn success">Save Branding</button>
            <div id="brandingSuccess" class="alert ok">Branding saved.</div>
            <div id="brandingError" class="alert err">Could not save branding.</div>
          </div>

          <!-- Settings -->
          <div>
            <h3>Settings</h3>
            <div class="field">
              <label for="agencyName">Agency name</label>
              <input id="agencyName" type="text" placeholder="Acme Studio" />
            </div>
            <div class="field">
              <label for="customDomain">Custom domain (optional)</label>
              <input id="customDomain" type="text" placeholder="agency.example.com" />
            </div>
            <button id="saveSettingsBtn" class="btn success">Save Settings</button>
            <div id="settingsSuccess" class="alert ok">Settings saved.</div>
            <div id="settingsError" class="alert err">Could not save settings.</div>

            <div class="divider"></div>
            <h3>Preview</h3>
            <div class="card" style="padding:16px;">
              <h2 id="previewTitle" style="color:#1e3a8a;">ScopeBuilderAI</h2>
              <div id="previewTagline" class="muted">Professional Proposal Generator</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Init + Admin logic (MUST be after SDKs) -->
  <script>
    // Theme
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); themeToggle.textContent = t === 'dark' ? 'Dark' : 'Light'; localStorage.setItem('sbai-theme', t); }
    applyTheme(localStorage.getItem('sbai-theme') || 'dark');
    themeToggle.addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDadaImEVf-rdcEPlza_UR3Kp--52wQbhI",
      authDomain: "scopebuilderai.firebaseapp.com",
      projectId: "scopebuilderai",
      storageBucket: "scopebuilderai.firebasestorage.app",
      messagingSenderId: "471021428025",
      appId: "1:471021428025:web:8246535fe30b2854701ce8"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    try { db.settings({ experimentalForceLongPolling: true, merge: true }); } catch(e){}

    // Helpers
    const authSection=document.getElementById('authSection');
    const adminDashboard=document.getElementById('adminDashboard');
    const logoutBtn=document.getElementById('logoutBtn');
    const authError=document.getElementById('authError');
    const resetInfo=document.getElementById('resetInfo');

    function flash(elId,msg,ok=true){
      const el=document.getElementById(elId);
      el.textContent=msg; el.className='alert '+(ok?'ok':'err'); el.style.display='block';
      setTimeout(()=> el.style.display='none', 1800);
    }
    function updatePreview(){
      document.getElementById('previewTitle').textContent = document.getElementById('siteTitle').value || 'ScopeBuilderAI';
      document.getElementById('previewTagline').textContent = document.getElementById('tagline').value || 'Professional Proposal Generator';
    }

    // Password eye
    const passEl=document.getElementById('password');
    const eyeBtn=document.getElementById('toggleEye');
    const eyeIcon=document.getElementById('eyeIcon');
    eyeBtn.addEventListener('click', ()=>{
      const isPwd=passEl.type==='password';
      passEl.type=isPwd?'text':'password';
      eyeIcon.textContent=isPwd?'üôà':'üëÅÔ∏è';
    });

    // Forgot password
    document.getElementById('forgotBtn').addEventListener('click', async ()=>{
      const email=document.getElementById('email').value.trim();
      resetInfo.style.display='none'; authError.style.display='none';
      if(!email){ authError.textContent='Enter your email first.'; authError.style.display='block'; return; }
      try { await auth.sendPasswordResetEmail(email); flash('resetInfo','Password reset email sent.',true); }
      catch(e){ authError.textContent=e.message; authError.style.display='block'; }
    });

    // Auth flow
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        authSection.style.display='none';
        adminDashboard.style.display='block';
        logoutBtn.style.display='inline-block';
        try{
          const ref=db.collection('agencies').doc(user.uid);
          const snap=await ref.get();
          if(snap.exists){
            const d=snap.data();
            document.getElementById('siteTitle').value=d.siteTitle||'ScopeBuilderAI';
            document.getElementById('tagline').value=d.tagline||'Professional Proposal Generator';
            document.getElementById('agencyName').value=d.agencyName||'';
            document.getElementById('customDomain').value=d.customDomain||'';
            if(d.logoUrl){
              const img=document.getElementById('logoImg'); img.src=d.logoUrl; img.style.display='block';
              document.getElementById('logoPlaceholder').style.display='none';
            }
            updatePreview();
          }
        }catch(e){ console.error(e); }
      } else {
        adminDashboard.style.display='none';
        logoutBtn.style.display='none';
        authSection.style.display='block';
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      authError.style.display='none'; resetInfo.style.display='none';
      const email=document.getElementById('email').value.trim();
      const password=passEl.value.trim();
      try{ await auth.signInWithEmailAndPassword(email,password); }
      catch(e){ authError.textContent=e.message; authError.style.display='block'; }
    });

    logoutBtn.addEventListener('click', async ()=>{ await auth.signOut(); });

    // Logo preview
    document.getElementById('logoFile').addEventListener('change', ()=>{
      const file=document.getElementById('logoFile').files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=e=>{
        const img=document.getElementById('logoImg');
        img.src=e.target.result; img.style.display='block';
        document.getElementById('logoPlaceholder').style.display='none';
      };
      reader.readAsDataURL(file);
    });

    // Save Branding
    document.getElementById('saveBrandingBtn').addEventListener('click', async ()=>{
      const user=auth.currentUser;
      const okEl='brandingSuccess', errEl='brandingError';
      if(!user){ flash(errEl,'Sign in first.',false); return; }
      const btn=e.target||document.getElementById('saveBrandingBtn'); btn.disabled=true; btn.textContent='Saving...';
      try{
        let logoUrl='';
        const file=document.getElementById('logoFile').files[0];
        if(file){
          const ref=storage.ref(`logos/${user.uid}/${file.name}`);
          await ref.put(file);
          logoUrl=await ref.getDownloadURL();
        }
        await db.collection('agencies').doc(user.uid).set({
          siteTitle: document.getElementById('siteTitle').value.trim(),
          tagline: document.getElementById('tagline').value.trim(),
          ...(logoUrl?{logoUrl}:{}),
        }, { merge:true });
        flash(okEl,'Branding saved.',true);
      }catch(e){ flash(errEl,e.message||'Could not save branding.',false); }
      finally{ btn.disabled=false; btn.textContent='Save Branding'; }
    });

    // Save Settings
    document.getElementById('saveSettingsBtn').addEventListener('click', async ()=>{
      const user=auth.currentUser;
      const okEl='settingsSuccess', errEl='settingsError';
      if(!user){ flash(errEl,'Sign in first.',false); return; }
      const btn=e.target||document.getElementById('saveSettingsBtn'); btn.disabled=true; btn.textContent='Saving...';
      try{
        await db.collection('agencies').doc(user.uid).set({
          agencyName: document.getElementById('agencyName').value.trim(),
          customDomain: document.getElementById('customDomain').value.trim()
        }, { merge:true });
        flash(okEl,'Settings saved.',true);
      }catch(e){ flash(errEl,e.message||'Could not save settings.',false); }
      finally{ btn.disabled=false; btn.textContent='Save Settings'; }
    });
  </script>
</body>
</html>
