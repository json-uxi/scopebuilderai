<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScopeBuilderAI ‚Äî Admin</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2a;
      --muted: #7b8aa5;
      --text: #e6eeff;
      --primary: #3a8bff;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #1f2a44;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, #17335a55 20%, transparent 60%),
                  radial-gradient(1200px 600px at 80% -10%, #17335a55 20%, transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .container { max-width: 980px; margin: 40px auto; padding: 0 16px; }

    /* Card */
    .card {
      background: linear-gradient(180deg, #111a2b 0%, #0e1627 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.04);
      padding: 24px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

    h1,h2,h3 { margin: 0 0 12px; }
    .muted { color: var(--muted); }

    /* Forms */
    .field { margin: 12px 0; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="email"], input[type="password"], input[type="color"] {
      width: 100%;
      background: #0b1322;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 12px 12px;
      outline: none;
    }
    input[type="file"] { color: var(--muted); }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #1a2b48 0%, #142239 100%);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
    }
    .btn.primary { border-color: #2e5fb5; background: linear-gradient(180deg, #2f66c7 0%, #244e98 100%); }
    .btn.success { border-color: #1a8a46; background: linear-gradient(180deg, #23b15a 0%, #1d8f4b 100%); }
    .btn.danger { border-color: #aa2a2a; background: linear-gradient(180deg, #ef4444 0%, #b72d2d 100%); }
    .btn.link { background: transparent; border-color: transparent; color: var(--muted); text-decoration: underline; }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #cde3ff;
      background: linear-gradient(180deg, #1a2b48 0%, #142239 100%);
      border: 1px solid var(--border);
    }

    .divider { height: 1px; background: var(--border); margin: 16px 0; }

    /* Logo preview */
    .logo-box {
      height: 84px; border: 1px dashed var(--border); border-radius: 12px;
      display: flex; align-items: center; justify-content: center; background: #0b1322;
      overflow: hidden;
    }
    .logo-box img { max-height: 84px; max-width: 100%; display: none; }

    /* Alerts */
    .alert {
      display: none; margin-top: 10px; padding: 10px 12px; border-radius: 10px; font-size: 14px;
    }
    .alert.ok { background: #0d2b1b; border: 1px solid #1b5e33; color: #b1f3c8; }
    .alert.err { background: #2b0d0d; border: 1px solid #5e1b1b; color: #f3b1b1; }

    /* Password field with eye icon */
    .password-wrap {
      position: relative;
    }
    .toggle-eye {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      cursor: pointer; color: var(--muted); user-select: none; font-size: 14px;
    }
    .actions { display: flex; align-items: center; gap: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div>
          <h1>ScopeBuilderAI <span class="pill">Admin</span></h1>
          <div class="muted">White‚Äëlabel settings for your agency</div>
        </div>
        <div>
          <button id="logoutBtn" class="btn danger" style="display:none;">Log out</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Auth section -->
      <section id="authSection">
        <h3>Sign in</h3>
        <form id="loginForm" autocomplete="on">
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="you@agency.com" required />
          </div>
          <div class="field password-wrap">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
            <span id="toggleEye" class="toggle-eye" title="Show/Hide">üëÅÔ∏è</span>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">Sign in</button>
            <button id="forgotBtn" class="btn link" type="button">Forgot password?</button>
          </div>
          <div id="authError" class="alert err"></div>
          <div id="resetInfo" class="alert ok"></div>
        </form>
      </section>

      <!-- Admin dashboard -->
      <section id="adminDashboard" style="display:none;">
        <div class="grid-2">
          <!-- Branding -->
          <div>
            <h3>Branding</h3>
            <div class="field">
              <label>Logo</label>
              <div class="logo-box">
                <img id="logoImg" alt="Logo preview" />
                <span id="logoPlaceholder" class="muted">No logo uploaded</span>
              </div>
              <input id="logoFile" type="file" accept="image/*" onchange="previewLogo()" />
            </div>

            <div class="field">
              <label for="siteTitle">Site title</label>
              <input id="siteTitle" type="text" placeholder="ScopeBuilderAI" />
            </div>

            <div class="field">
              <label for="tagline">Tagline</label>
              <input id="tagline" type="text" placeholder="Professional Proposal Generator" />
            </div>

            <div class="row">
              <div class="field">
                <label for="primaryColor">Primary color</label>
                <input id="primaryColor" type="color" value="#1e3a8a" />
              </div>
              <div class="field">
                <label for="secondaryColor">Secondary color</label>
                <input id="secondaryColor" type="color" value="#3a8bff" />
              </div>
            </div>

            <button class="btn success" onclick="saveBranding()">Save Branding</button>
            <div id="brandingSuccess" class="alert ok">Branding saved.</div>
            <div id="brandingError" class="alert err">Could not save branding.</div>
          </div>

          <!-- Settings -->
          <div>
            <h3>Settings</h3>
            <div class="field">
              <label for="agencyName">Agency name</label>
              <input id="agencyName" type="text" placeholder="Acme Studio" />
            </div>
            <div class="field">
              <label for="customDomain">Custom domain (optional)</label>
              <input id="customDomain" type="text" placeholder="agency.example.com" />
            </div>
            <button class="btn success" onclick="saveSettings()">Save Settings</button>
            <div id="settingsSuccess" class="alert ok">Settings saved.</div>
            <div id="settingsError" class="alert err">Could not save settings.</div>

            <div class="divider"></div>

            <h3>Preview</h3>
            <div class="card" style="padding:16px;">
              <h2 id="previewTitle" style="color:#1e3a8a;">ScopeBuilderAI</h2>
              <div id="previewTagline" class="muted">Professional Proposal Generator</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase SDKs (v8 namespaced) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- Initialize Firebase (single init) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDadaImEVf-rdcEPlza_UR3Kp--52wQbhI",
      authDomain: "scopebuilderai.firebaseapp.com",
      projectId: "scopebuilderai",
      storageBucket: "scopebuilderai.firebasestorage.app",
      messagingSenderId: "471021428025",
      appId: "1:471021428025:web:8246535fe30b2854701ce8"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>

  <!-- Admin logic -->
  <script>
    // UI helpers
    function flash(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 1800);
    }
    function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val; }
    function updatePreview() {
      document.getElementById('previewTitle').textContent = document.getElementById('siteTitle').value || 'ScopeBuilderAI';
      document.getElementById('previewTagline').textContent = document.getElementById('tagline').value || 'Professional Proposal Generator';
      const pc = document.getElementById('primaryColor').value || '#1e3a8a';
      document.getElementById('previewTitle').style.color = pc;
    }
    function previewLogo() {
      const file = document.getElementById('logoFile').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById('logoImg');
        img.src = e.target.result;
        img.style.display = 'block';
        document.getElementById('logoPlaceholder').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    // Password eye toggle
    const passEl = document.getElementById('password');
    const eyeEl = document.getElementById('toggleEye');
    eyeEl.addEventListener('click', () => {
      const isPwd = passEl.type === 'password';
      passEl.type = isPwd ? 'text' : 'password';
      eyeEl.textContent = isPwd ? 'üôà' : 'üëÅÔ∏è';
    });

    // Forgot password flow
    const forgotBtn = document.getElementById('forgotBtn');
    const resetInfo = document.getElementById('resetInfo');
    const authError = document.getElementById('authError');
    forgotBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      resetInfo.style.display = 'none';
      authError.style.display = 'none';
      if (!email) {
        authError.textContent = 'Enter your email first, then click ‚ÄúForgot password?‚Äù.';
        authError.style.display = 'block';
        return;
      }
      try {
        await auth.sendPasswordResetEmail(email);
        resetInfo.textContent = 'Password reset email sent. Check your inbox.';
        resetInfo.style.display = 'block';
      } catch (e) {
        authError.textContent = e.message;
        authError.style.display = 'block';
      }
    });

    // Auth state
    const authSection = document.getElementById('authSection');
    const adminDashboard = document.getElementById('adminDashboard');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentUser = null;
    let currentAgencyId = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        currentAgencyId = user.uid;
        authSection.style.display = 'none';
        adminDashboard.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        await loadAgencyData();
      } else {
        currentUser = null;
        currentAgencyId = null;
        authSection.style.display = 'block';
        adminDashboard.style.display = 'none';
        logoutBtn.style.display = 'none';
      }
    });

    // Login handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.style.display = 'none';
      resetInfo.style.display = 'none';
      const email = document.getElementById('email').value.trim();
      const password = passEl.value.trim();
      try {
        await auth.signInWithEmailAndPassword(email, password);
        authError.textContent = '';
      } catch (err) {
        authError.textContent = err.message;
        authError.style.display = 'block';
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => { await auth.signOut(); });

    // Load agency doc
    async function loadAgencyData() {
      try {
        const snap = await db.collection('agencies').doc(currentAgencyId).get();
        if (snap.exists) {
          const d = snap.data();
          setVal('siteTitle', d.siteTitle || 'ScopeBuilderAI');
          setVal('tagline', d.tagline || 'Professional Proposal Generator');
          setVal('primaryColor', d.primaryColor || '#1e3a8a');
          setVal('secondaryColor', d.secondaryColor || '#3a8bff');
          setVal('agencyName', d.agencyName || '');
          setVal('customDomain', d.customDomain || '');
          if (d.logoUrl) {
            const img = document.getElementById('logoImg');
            img.src = d.logoUrl;
            img.style.display = 'block';
            document.getElementById('logoPlaceholder').style.display = 'none';
          }
          updatePreview();
        } else {
          await db.collection('agencies').doc(currentAgencyId).set({
            siteTitle: 'ScopeBuilderAI',
            tagline: 'Professional Proposal Generator'
          }, { merge: true });
        }
      } catch (e) { console.error(e); }
    }

    // Save branding
    async function saveBranding() {
      try {
        let logoUrl = '';
        const file = document.getElementById('logoFile').files[0];
        if (file) {
          const ref = storage.ref(`logos/${currentAgencyId}/${file.name}`);
          await ref.put(file);
          logoUrl = await ref.getDownloadURL();
        }
        await db.collection('agencies').doc(currentAgencyId).set({
          siteTitle: document.getElementById('siteTitle').value.trim(),
          tagline: document.getElementById('tagline').value.trim(),
          primaryColor: document.getElementById('primaryColor').value,
          secondaryColor: document.getElementById('secondaryColor').value,
          ...(logoUrl && { logoUrl })
        }, { merge: true });
        updatePreview();
        flash('brandingSuccess');
      } catch (e) { flash('brandingError'); }
    }
    window.saveBranding = saveBranding;

    // Save settings
    async function saveSettings() {
      try {
        await db.collection('agencies').doc(currentAgencyId).set({
          agencyName: document.getElementById('agencyName').value.trim(),
          customDomain: document.getElementById('customDomain').value.trim()
        }, { merge: true });
        flash('settingsSuccess');
      } catch (e) { flash('settingsError'); }
    }
    window.saveSettings = saveSettings;
  </script>
</body>
</html>
